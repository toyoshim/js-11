<!DOCTYPE html>
<html>
<head>
    <title>v6</title>
    <script src="js/Log.js"></script>
    <script src="js/Cpu.js"></script>
    <script src="js/CpuPdp11.js"></script>
    <script src="js/Memory.js"></script>
    <script src="js/MemoryUnibus.js"></script>
    <script src="js/DeviceMmu.js"></script>
    <script src="js/DeviceRk.js"></script>
    <script src="js/DeviceTt.js"></script>
    <script src="js/DeviceKw.js"></script>
    <script src="js/Pdp11.js"></script>
    <script src="term.js"></script>
</head>
<body>
    <!--pre>TODO:
* Remove browser dependant code into separated class.
* Interrupt priority.
* MUL/DIV detail implementation.
* Memory protection.
* Safari mobile support.
* Lots of unimplemented things...
==== CONSOLE ====</pre-->
    <script>
        pdp11_reset = function () {
            pdp11.cpu.init();
            pdp11.bootRk0();
            pdp11.memory.tt.set(new String("unix\n"));
            clearInterval(tid);
            tid = setInterval(pdp11_loop, 10);
        };
        pdp11_start = function() {
            clearInterval(tid);
            tid = setInterval(pdp11_loop, 10);
        };
        pdp11_stop = function () {
            clearInterval(tid);
            pdp11.stop();
        };
        pdp11_log = function () {
            pdp11_clear();
            Log.setLog(new Log("log", document.control.reversed.value));
            pdp11_select();
        };
        pdp11_select = function () {
            var level = [Log.INFO, Log.WARN, Log.ERROR, Log.FATAL];
            Log.getLog().setLevel(level[document.control.level.selectedIndex]);
        };
        pdp11_loop = function () {
            try {
                pdp11.run();
            } catch (e) {
                clearInterval(tid);
                Log.getLog().fatal(e);
            }
        };
        pdp11_clear = function () {
            Log.getLog().clear();
        };
        pdp11_mdump = function () {
            if (document.control.mdump.value) {
                pdp11.memory.logging = true;
                document.control.level.selectedIndex = 0;
                pdp11_select();
            } else {
                pdp11.memory.logging = false;
            }
        };
        pdp11_rdump = function () {
            if (document.control.rdump.value) {
                pdp11.logging = true;
                document.control.level.selectedIndex = 0;
                pdp11_select();
            } else {
                pdp11.logging = false;
            }
        };
        pdp11_rdump_now = function () {
            Log.getLog().setLevel(Log.INFO);
            pdp11.dump();
            pdp11_select();
        };
        pdp11_cons = function () {
            pdp11.memory.tt.cons = document.control.cons.value;
        };
        pdp11_wslog = function () {
            if (document.control.wslog.value)
                Log.setLog(new Log(new WebSocket("ws://localhost:8080/log")));
            else
                pdp11_log();
            pdp11_select();
        };
    </script>
    <pre id="term"
         style="background-color: black;
                color: green;
                display: inline-block;"></pre>
    <div style="font-family: monospace;"><form name="control">
        [PDP-11]
            <input type="button" value="RESET" onclick="pdp11_reset();">
            <input type="button" value="START" onclick="pdp11_start();">
            <input type="button" value="STOP" onclick="pdp11_stop();"><br>
        [LOG]
        REVERSED
            <input type="checkbox" name="reversed" checked="true"
                   onchange="pdp11_log();">
        LEVEL
            <select name="level" onchange="pdp11_select();">
            <option>INFO</option>
            <option>WARN</option>
            <option selected="selected">ERROR</option>
            <option>FATAL</option></select>
        REG DUMP
            <input type="checkbox" name="rdump" onchange="pdp11_rdump();">
            <input type="button" value="NOW" onclick="pdp11_rdump_now();">
        MEM DUMP
            <input type="checkbox" name="mdump" onchange="pdp11_mdump();">
            <input type="button" value="CLEAR" onclick="pdp11_clear();"><br>
        [CONSOLE]
            <input type="checkbox" name="cons" checked="true"
                   onchange="pdp11_cons();"><br>
        [DEBUG]
        Log to ws://localhost:8080/log
            <input type="checkbox" name="wslog" onchange="pdp11_wslog();">
    </form></div>
    <pre>==== DEBUG LOG ====</pre>
    <pre id="log"></pre>
    <script>
        Log.setLog(new Log("log", true));
        Log.getLog().setLevel(Log.ERROR);
        var pdp11 = new Pdp11();
        var term = new Term("term", 80, 25);
        term.appendString("v6/js-11 booting from rk0 ...\n");
        pdp11.memory.tt.setCallback(function (c) { term.appendCharacter(c); });
        document.onkeypress = function (e) { pdp11.memory.tt.set(e.which); };
        pdp11.memory.tt.set(new String("unix\n"));  // Queue auto-boot console inputs
        pdp11.mountRk0("./data/v6root");
        pdp11.bootRk0();
        var tid = setInterval(pdp11_loop, 10);
    </script>
</body>
</html>
